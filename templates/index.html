<!DOCTYPE html>
<html>
<head>
    <title>Project Management Tool</title>
    <link rel="stylesheet" href="/static/style.css">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body>
    <h1>Project Management Tool</h1>

    <!-- Forms for adding entities -->
    <h2>Add Goal</h2>
    <form method="post" action="/add_goal">
        <label>Title: <input type="text" name="title" required></label><br>
        <label>Time Horizon: <input type="text" name="time_horizon" required></label><br>
        <label>Rationale: <textarea name="rationale" required></textarea></label><br>
        <label>Key Metrics: <textarea name="key_metrics" required></textarea></label><br>
        <button type="submit">Add Goal</button>
    </form>

    <h2>Add Subgoal</h2>
    <form method="post" action="/add_subgoal">
        <label>Goal: <select name="goal_id" required>
            {% for goal in goals %}
                <option value="{{ goal.id }}">{{ goal.title }}</option>
            {% endfor %}
        </select></label><br>
        <label>Title: <input type="text" name="title" required></label><br>
        <label>Time Horizon: <input type="text" name="time_horizon" required></label><br>
        <label>Rationale: <textarea name="rationale" required></textarea></label><br>
        <label>Key Metrics: <textarea name="key_metrics" required></textarea></label><br>
        <button type="submit">Add Subgoal</button>
    </form>

    <h2>Add Task</h2>
    <form method="post" action="/add_task">
        <label>Subgoal: <select name="subgoal_id" required>
            {% for goal in goals %}
                {% for subgoal in goal.subgoals %}
                    <option value="{{ subgoal.id }}">{{ goal.title }} - {{ subgoal.title }}</option>
                {% endfor %}
            {% endfor %}
        </select></label><br>
        <label>Title: <input type="text" name="title" required></label><br>
        <button type="submit">Add Task</button>
    </form>

    <h2>Add Subtask</h2>
    <form method="post" action="/add_subtask">
        <label>Task: <select name="task_id" required>
            {% for goal in goals %}
                {% for subgoal in goal.subgoals %}
                    {% for task in subgoal.tasks %}
                        <option value="{{ task.id }}">{{ goal.title }} - {{ subgoal.title }} - {{ task.title }}</option>
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        </select></label><br>
        <label>Title: <input type="text" name="title" required></label><br>
        <button type="submit">Add Subtask</button>
    </form>

    <!-- Hierarchy display -->
    <h2>Hierarchy</h2>
    <ul>
        {% for goal in goals %}
            <li>
                <strong>{{ goal.title }}</strong>
                <p>Time Horizon: {{ goal.time_horizon }}</p>
                <p>Rationale: {{ goal.rationale }}</p>
                <p>Key Metrics:</p>
                <ul>
                    {% for metric in goal.key_metrics.split('\n') %}
                        <li>{{ metric }}</li>
                    {% endfor %}
                </ul>
                <ul>
                    {% for subgoal in goal.subgoals %}
                        <li>
                            <strong>Subgoal: {{ subgoal.title }}</strong>
                            <p>Time Horizon: {{ subgoal.time_horizon }}</p>
                            <p>Rationale: {{ subgoal.rationale }}</p>
                            <p>Key Metrics:</p>
                            <ul>
                                {% for metric in subgoal.key_metrics.split('\n') %}
                                    <li>{{ metric }}</li>
                                {% endfor %}
                            </ul>
                            <ul>
                                {% for task in subgoal.tasks %}
                                    <li class="{% if task.completed %}completed{% endif %}">
                                        Task: {{ task.title }}
                                        <form method="post" action="/toggle_completion">
                                            <input type="hidden" name="entity_type" value="task">
                                            <input type="hidden" name="entity_id" value="{{ task.id }}">
                                            <input type="checkbox" name="completed" {% if task.completed %}checked{% endif %} onchange="this.form.submit()">
                                        </form>
                                        <ul>
                                            {% for subtask in task.subtasks %}
                                                <li class="{% if subtask.completed %}completed{% endif %}">
                                                    Sub-Task: {{ subtask.title }}
                                                    <form method="post" action="/toggle_completion">
                                                        <input type="hidden" name="entity_type" value="subtask">
                                                        <input type="hidden" name="entity_id" value="{{ subtask.id }}">
                                                        <input type="checkbox" name="completed" {% if subtask.completed %}checked{% endif %} onchange="this.form.submit()">
                                                    </form>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>

    <!-- Visualization -->
    <h2>Visualization</h2>
    <div id="network" style="height: 600px; border: 1px solid lightgray;"></div>
    <script type="text/javascript">
        var nodes = new vis.DataSet({{ nodes | tojson }});
        var edges = new vis.DataSet({{ edges | tojson }});
        var container = document.getElementById('network');
        var data = { nodes: nodes, edges: edges };
        var options = {
            layout: {
                hierarchical: {
                    direction: "UD",
                    sortMethod: "directed"
                }
            },
            nodes: {
                shape: 'dot',
                size: 20,
                font: { size: 14 }
            },
            edges: { arrows: 'to' }
        };
        var network = new vis.Network(container, data, options);
    </script>
</body>
</html>